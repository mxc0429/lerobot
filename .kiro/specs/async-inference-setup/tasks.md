# Implementation Plan

- [ ] 1. 环境准备和依赖安装
  - 在服务器和本地设备上安装异步推理依赖
  - 验证 Python 环境和 LeRobot 安装
  - _Requirements: 1.1, 2.1, 4.1_

- [ ] 1.1 服务器端环境配置
  - 确认 CUDA 可用性（运行 `nvidia-smi`）
  - 安装异步推理依赖：`pip install -e ".[async]"`
  - 验证模型文件路径存在：`outputs/train/smolvla_so101_test2`
  - _Requirements: 1.1, 1.2, 5.1, 5.2_

- [ ] 1.2 本地设备环境配置
  - 安装异步推理依赖：`pip install -e ".[async]"`
  - 确认机械臂设备连接：检查 `/dev/ttyACM0` 和 `/dev/ttyACM1`
  - 确认相机设备连接：检查 `/dev/video2`, `/dev/video4`, `/dev/video6`
  - 运行 `python lerobot/find_cameras.py` 测试相机
  - _Requirements: 2.1, 2.2, 2.3, 6.1_

- [ ] 2. 网络连接配置和测试
  - 配置服务器防火墙规则
  - 测试网络连通性
  - 验证端口可访问性
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 2.1 服务器网络配置
  - 确认服务器 IP 地址为 172.21.137.91
  - 检查端口 8080 未被占用：`netstat -tuln | grep 8080`
  - 配置防火墙允许 8080 端口（如需要）：`sudo ufw allow 8080/tcp`
  - _Requirements: 4.1_

- [x] 2.2 本地设备网络测试
  - 测试到服务器的网络连通性：`ping 172.21.137.91`
  - 测试端口连接：`telnet 172.21.137.91 8080`（或 `nc -zv 172.21.137.91 8080`）
  - 记录网络延迟基准值
  - _Requirements: 4.2, 4.3_

- [ ] 3. 创建服务器启动脚本
  - 编写 PolicyServer 启动脚本
  - 配置日志输出
  - 添加错误处理
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 3.1 编写 start_policy_server.sh 脚本
  - 创建脚本文件 `scripts/start_policy_server.sh`
  - 包含完整的启动命令和参数
  - 添加日志重定向到文件
  - 添加进程管理（后台运行、PID 记录）
  - _Requirements: 1.1, 1.2_

- [ ] 3.2 测试服务器启动
  - 运行启动脚本
  - 验证服务器成功监听 8080 端口
  - 检查日志输出是否正常
  - 测试服务器停止和重启
  - _Requirements: 1.1, 1.5_

- [ ] 4. 创建客户端启动脚本
  - 编写 RobotClient 启动脚本
  - 配置所有必需参数
  - 添加调试选项
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 4.1 编写 start_robot_client.sh 脚本
  - 创建脚本文件 `scripts/start_robot_client.sh`
  - 包含完整的机械臂和相机配置
  - 包含服务器地址和策略配置
  - 包含异步推理参数（actions_per_chunk, chunk_size_threshold）
  - 添加调试选项（debug_visualize_queue_size）
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 4.2 添加参数验证
  - 在脚本中添加设备存在性检查
  - 验证服务器连接性
  - 提供清晰的错误提示
  - _Requirements: 2.1, 2.2, 2.3, 4.4_

- [ ] 5. 端到端连接测试
  - 启动服务器和客户端
  - 验证握手成功
  - 测试数据传输
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.4, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3_

- [ ] 5.1 执行首次连接测试
  - 按顺序启动服务器和客户端
  - 观察两端日志输出
  - 验证策略配置正确传输
  - 验证模型成功加载到 CUDA
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.4, 5.1, 5.2_

- [ ] 5.2 验证观察数据传输
  - 确认客户端成功采集相机图像
  - 确认服务器接收到观察数据
  - 检查数据序列化/反序列化是否正确
  - 测量单向网络延迟
  - _Requirements: 2.3, 2.5, 3.1, 4.2, 4.3, 4.5, 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 5.3 验证动作数据传输
  - 确认服务器成功执行推理
  - 确认客户端接收到动作块
  - 验证动作块大小正确（actions_per_chunk）
  - 确认机械臂执行动作
  - _Requirements: 1.3, 1.4, 1.5, 3.2, 3.3, 3.4, 3.5, 5.3_

- [ ] 6. 性能测试和参数调优
  - 测量系统延迟
  - 分析动作队列行为
  - 调整关键参数
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 5.3, 5.4, 5.5, 7.1, 7.2_

- [ ] 6.1 收集性能基准数据
  - 启用 `debug_visualize_queue_size=True`
  - 运行完整任务周期
  - 记录推理延迟、网络延迟、FPS
  - 保存动作队列大小可视化图表
  - _Requirements: 7.1, 7.2, 7.5_

- [ ] 6.2 调优 actions_per_chunk 参数
  - 测试不同值：20, 30, 50, 100
  - 观察队列为空的频率
  - 评估动作执行平滑度
  - 选择最优值
  - _Requirements: 3.1, 3.2, 3.3, 5.3_

- [ ] 6.3 调优 chunk_size_threshold 参数
  - 测试不同值：0.3, 0.5, 0.7
  - 观察观察发送频率
  - 评估系统适应性
  - 平衡网络带宽和响应速度
  - _Requirements: 3.1, 3.4, 5.4_

- [ ] 6.4 测试不同聚合函数
  - 测试 weighted_average, latest_only, average, conservative
  - 评估动作执行质量
  - 选择最适合任务的聚合函数
  - _Requirements: 3.4, 5.4_

- [ ] 7. 创建使用文档
  - 编写快速启动指南
  - 记录常见问题和解决方案
  - 提供参数调优建议
  - _Requirements: 所有需求_

- [x] 7.1 编写 ASYNC_INFERENCE_GUIDE.md
  - 创建文档文件
  - 包含系统架构说明
  - 包含完整的启动步骤
  - 包含参数说明和调优建议
  - 包含故障排查指南
  - _Requirements: 所有需求_

- [ ]* 7.2 添加示例配置文件
  - 创建 `configs/async_server_example.yaml`
  - 创建 `configs/async_client_example.yaml`
  - 包含详细的参数注释
  - _Requirements: 1.1, 2.1, 3.1, 5.1_

- [ ] 8. 故障恢复测试
  - 测试网络中断场景
  - 测试设备断开场景
  - 验证错误处理
  - _Requirements: 4.4, 7.3, 7.4_

- [ ] 8.1 测试网络中断恢复
  - 运行过程中断开网络连接
  - 验证客户端检测到错误并停止机械臂
  - 验证错误日志清晰
  - 测试重新连接流程
  - _Requirements: 4.4, 7.3, 7.4_

- [ ] 8.2 测试相机设备故障
  - 模拟相机断开
  - 验证系统能够检测并记录错误
  - 确认不会导致程序崩溃
  - _Requirements: 6.1, 7.3_

- [ ]* 8.3 测试服务器重启场景
  - 运行过程中重启服务器
  - 验证客户端能够检测到连接丢失
  - 测试客户端重新连接机制（如果实现）
  - _Requirements: 4.4, 7.3_
